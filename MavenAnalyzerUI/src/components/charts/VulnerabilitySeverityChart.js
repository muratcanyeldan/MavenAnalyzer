import React, { useMemo } from 'react';
import { ResponsiveBar } from '@nivo/bar';
import { Box, Typography, CircularProgress } from '@mui/material';

/**
 * Vulnerability Severity Chart component using Nivo
 * Displays the distribution of vulnerability severity levels
 * 
 * @param {Object} props - Component props
 * @param {Object} props.data - Either analysis data object or bar chart data from API
 * @param {boolean} props.loading - Loading state
 * @param {number} props.height - Chart height in pixels
 */
const VulnerabilitySeverityChart = ({ data, loading, height = 300 }) => {
  // Process data to get vulnerability counts by severity
  const severityData = useMemo(() => {
    // Check if we have the new API data format
    if (data?.data && Array.isArray(data.data)) {
      // We have data from the chart data API
      return data.data.filter(entry => entry.category !== 'No Vulnerabilities' || data.data.length === 1);
    }
    
    // Fallback to the old format (analysis object with dependencies)
    if (!data || !data.dependencies || !Array.isArray(data.dependencies)) {
      return [];
    }

    // Initialize counters for each severity level
    const counts = {
      Critical: 0,
      High: 0,
      Medium: 0,
      Low: 0,
      Unknown: 0 // Added Unknown category
    };

    // Count vulnerabilities by severity
    data.dependencies.forEach(dependency => {
      if (dependency.vulnerabilities && Array.isArray(dependency.vulnerabilities)) {
        dependency.vulnerabilities.forEach(vuln => {
          // Normalize severity to handle case differences (CRITICAL vs Critical)
          let severity = vuln.severity || 'Unknown';
          
          // Normalize case for consistency
          if (severity.toUpperCase() === 'CRITICAL') severity = 'Critical';
          else if (severity.toUpperCase() === 'HIGH') severity = 'High';
          else if (severity.toUpperCase() === 'MEDIUM') severity = 'Medium';
          else if (severity.toUpperCase() === 'LOW') severity = 'Low';
          else if (severity.toUpperCase() === 'UNKNOWN' || !severity) severity = 'Unknown';
          else if (severity === undefined || severity === null) severity = 'Unknown';
          
          if (severity !== 'None') {
            counts[severity] = (counts[severity] || 0) + 1;
          }
        });
      }
    });

    // Convert to the format expected by the bar chart
    const result = Object.entries(counts)
      .filter(([_, count]) => count > 0) // Only include non-zero values
      .map(([severity, count]) => ({
        category: severity,
        count: count,
        color: getColorForSeverity(severity)
      }));

    console.log('Processed vulnerability data:', result);
    return result;
  }, [data]);

  // Calculate a clean summary text without any "undefined" in it
  const cleanSummary = useMemo(() => {
    if (!severityData || severityData.length === 0) {
      console.log('No severity data found for summary');
      return null;
    }
    
    // Check if we have a "No Vulnerabilities" placeholder but actual vulnerabilities in the data
    const hasActualVulnerabilities = data?.dependencies?.some(dep => 
      dep.vulnerabilities && dep.vulnerabilities.length > 0
    );

    if (severityData.length === 1 && 
        severityData[0].category === 'No Vulnerabilities' && 
        hasActualVulnerabilities) {
      return "Processing vulnerability data...";
    }
    
    const severityCounts = severityData
      .filter(item => item && item.category && item.category !== 'Unknown')
      .map(item => `${item.count} ${item.category?.toLowerCase() || 'unknown'}`)
      .join(', ');
      
    const unknownCount = severityData.find(item => item && (!item.category || item.category === 'Unknown'))?.count || 
                         severityData.filter(item => item && (!item.category || item.category === 'Unknown'))
                                     .reduce((sum, item) => sum + (item.count || 0), 0);
    
    if (severityCounts && unknownCount > 0) {
      return `${severityCounts}, and ${unknownCount} with unspecified severity level`;
    } else if (severityCounts) {
      return severityCounts;
    } else if (unknownCount > 0) {
      return `${unknownCount} with unspecified severity level`;
    }
    
    return "No vulnerability severity data available";
  }, [severityData]);
  
  // Add the clean summary to the data object if it's going to be used elsewhere
  if (data) {
    data.cleanSummary = cleanSummary || "No vulnerability severity data available";
  }

  // Return loading indicator if data is loading
  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height }}>
        <CircularProgress />
      </Box>
    );
  }

  // Return message if no data available
  if (severityData.length === 0 || (severityData.length === 1 && severityData[0].category === 'No Vulnerabilities')) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height, p: 2 }}>
        <Typography color="text.secondary">No vulnerability severity data available</Typography>
      </Box>
    );
  }

  return (
    <Box sx={{ height }}>
      <ResponsiveBar
        data={severityData}
        keys={data?.keys || ['count']}
        indexBy="category"
        margin={{ top: 40, right: 50, bottom: 40, left: 60 }}
        padding={0.3}
        valueScale={{ type: 'linear' }}
        indexScale={{ type: 'band', round: true }}
        colors={({ data }) => data.color}
        borderColor={{ from: 'color', modifiers: [['darker', 1.6]] }}
        axisTop={null}
        axisRight={null}
        axisBottom={{
          tickSize: 5,
          tickPadding: 5,
          tickRotation: 0,
          legend: 'Severity Level',
          legendPosition: 'middle',
          legendOffset: 32
        }}
        axisLeft={{
          tickSize: 5,
          tickPadding: 5,
          tickRotation: 0,
          legend: 'Count',
          legendPosition: 'middle',
          legendOffset: -40
        }}
        enableGridY={true}
        labelSkipWidth={12}
        labelSkipHeight={12}
        labelTextColor={{ from: 'color', modifiers: [['darker', 1.6]] }}
        animate={true}
        motionStiffness={90}
        motionDamping={15}
        legends={[]}
      />
    </Box>
  );
};

// Helper function to get color based on severity
function getColorForSeverity(severity) {
  switch (severity) {
    case 'Critical':
      return '#d32f2f'; // dark red
    case 'High':
      return '#f44336'; // red
    case 'Medium':
      return '#ff9800'; // orange
    case 'Low':
      return '#ffeb3b'; // yellow
    case 'Unknown':
      return '#9e9e9e'; // grey for unknown
    default:
      return '#9e9e9e'; // grey for any other case
  }
}

export default VulnerabilitySeverityChart; 